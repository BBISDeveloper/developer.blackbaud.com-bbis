/*
//===============================================================================================================
// System  : Sandcastle Help File Builder
// File    : branding-Website.js
// Author  : Eric Woodruff  (Eric@EWoodruff.us)
// Updated : 05/16/2014
// Note    : Copyright 2014, Eric Woodruff, All rights reserved
//           Portions Copyright 2014 Sam Harwell, All rights reserved
//
// This file contains the methods necessary to implement the lightweight TOC and search functionality.
//
// This code is published under the Microsoft Public License (Ms-PL).  A copy of the license should be
// distributed with the code.  It can also be found at the project website: http://SHFB.CodePlex.com.  This
// notice, the author's name, and all copyright notices must remain intact in all applications, documentation,
// and source files.
//
//    Date     Who  Comments
// ==============================================================================================================
// 05/04/2014  EFW  Created the code based on a combination of the lightweight TOC code from Sam Harwell and
//                  the existing search code from SHFB.
//===============================================================================================================
*/

var tocWidth,searchMethod=0;function InitializeToc(){tocWidth=parseInt(GetCookie("TocWidth","280"));ResizeToc()}function OnIncreaseToc(){tocWidth=1>tocWidth?280:tocWidth+100;680<tocWidth&&(tocWidth=0);ResizeToc();SetCookie("TocWidth",tocWidth)}function OnResetToc(){tocWidth=0;ResizeToc();SetCookie("TocWidth",tocWidth)}
function ResizeToc(){var a=document.getElementById("leftNav");a&&(a.style.width=tocWidth+"px",document.getElementById("TopicContent").style.marginLeft=tocWidth+10+"px",document.getElementById("TocResize").style.left=tocWidth+10+"px",document.getElementById("ResizeImageIncrease").style.display=680<=tocWidth?"none":"",document.getElementById("ResizeImageReset").style.display=680>tocWidth?"none":"")}
function Toggle(a){var c=$(a).hasClass("tocExpanded");$(a).toggleClass("tocExpanded tocCollapsed");c?Collapse($(a).parent()):$(a).parent().attr("data-childrenloaded")?Expand($(a).parent()):(c=$(a).next().attr("tocid"),$.ajax({url:"../toc/"+c+".xml",async:!0,dataType:"xml",success:function(b){BuildChildren($(a).parent(),b)}}))}function HtmlEncode(a){return $("<div/>").text(a).html()}
function BuildChildren(a,c){var b=+a.attr("data-toclevel")+1,m=10<=b?10:b,k=c.getElementsByTagName("HelpTOCNode"),h=!0;0==c.getElementsByTagName("HelpTOC").length&&(h=!1);for(var e=k.length-1;0<e||h&&0==e;e--){var l,d=k[e].getAttribute("Url");null!=d&&5<d.length?(l=d.substring(5,d.length),d=d.substring(5,d.lastIndexOf("."))):(l="#",d=k[e].getAttribute("Id"));var f=null;a.nextAll().each(function(){f||$(this).children().last("a").attr("tocid")!=d||(f=$(this))});if(null!=f){var g=+f.attr("data-toclevel"),
n=!1,p=a;f.nextAll().each(function(){!n&&+$(this).attr("data-toclevel")>g?(p.after($(this)),p=$(this),$(this).attr("data-toclevel",+$(this).attr("data-toclevel")+b-g),$(this).hasClass("current")?$(this).attr("class","toclevel"+(+$(this).attr("data-toclevel")+" current")):$(this).attr("class","toclevel"+ +$(this).attr("data-toclevel"))):n=!0});a.after(f);f.attr("data-toclevel",b);f.attr("class","toclevel"+b)}else{var s=k[e].getAttribute("HasChildren"),q=HtmlEncode(k[e].getAttribute("Title")),r="";
s&&(r='<a class="tocCollapsed" onclick="javascript: Toggle(this);" href="#!"></a>');a.after('<div class="toclevel'+m+'" data-toclevel="'+b+'">'+r+'<a data-tochassubtree="'+s+'" href="'+l+'" title="'+q+'" tocid="'+d+'">'+q+"</a></div>")}}a.attr("data-childrenloaded",!0)}function Collapse(a){var c=+a.attr("data-toclevel"),b=!1;a.nextAll().each(function(){!b&&+$(this).attr("data-toclevel")>c?$(this).hide():b=!0})}
function Expand(a){var c=+a.attr("data-toclevel"),b=!1;a.nextAll().each(function(){if(!b){var a=+$(this).attr("data-toclevel");a==c+1?($(this).show(),$(this).children("a").first().hasClass("tocExpanded")&&Expand($(this))):a>c+1||(b=!0)}})}function OnMouseDown(a){document.addEventListener("mousemove",OnMouseMove,!0);document.addEventListener("mouseup",OnMouseUp,!0);a.preventDefault()}function OnMouseMove(a){tocWidth=700<a.clientX?700:100>a.clientX?100:a.clientX;ResizeToc()}
function OnMouseUp(a){document.removeEventListener("mousemove",OnMouseMove,!0);document.removeEventListener("mouseup",OnMouseUp,!0);SetCookie("TocWidth",tocWidth)}function TransferToSearchPage(){var a=document.getElementById("SearchTextBox").value.trim();0!=a.length&&document.location.replace(encodeURI("../search.html?SearchText="+a))}
function OnSearchPageLoad(){var a=decodeURI(document.location.search);if(""!=a)for(var c=a.split(/[\?\=\&]/),a=0;a<c.length;a++)if("SearchText"==c[a]&&a+1<c.length){document.getElementById("txtSearchText").value=c[a+1];PerformSearch();break}}
function PerformSearch(){var a=document.getElementById("txtSearchText").value,c=document.getElementById("chkSortByTitle").checked,b=document.getElementById("searchResults");if(0==a.length)b.innerHTML="<strong>Nothing found</strong>";else if(b.innerHTML="Searching...",0==searchMethod&&(searchMethod=DetermineSearchMethod()),1==searchMethod)$.ajax({type:"GET",url:encodeURI("SearchHelp.aspx?Keywords="+a+"&SortByTitle="+c),success:function(a){b.innerHTML=a}});else if(2==searchMethod)$.ajax({type:"GET",
url:encodeURI("SearchHelp.php?Keywords="+a+"&SortByTitle="+c),success:function(a){b.innerHTML=a}});else{var a=ParseKeywords(a),m=[];$.ajax({type:"GET",url:"fti/FTI_Files.json",dataType:"json",async:!1,success:function(a){$.each(a,function(a,b){m[a]=b})}});for(var k=[],h=[],e=!1,l=0;l<a.length&&!e;l++){var d=a[l].substring(0,1);-1==$.inArray(d,k)&&(k.push(d),$.ajax({type:"GET",url:"fti/FTI_"+d.charCodeAt(0)+".json",dataType:"json",async:!1,success:function(a){var b=0;$.each(a,function(a,c){h[a]=c;
b++});0==b&&(e=!0)}}))}b.innerHTML=e?"<strong>Nothing found</strong>":SearchForKeywords(a,m,h,c)}}function DetermineSearchMethod(){var a=3;try{$.ajax({type:"GET",url:"SearchHelp.aspx",async:!1,success:function(b){"<strong>"==b.substring(0,8)&&(a=1)}}),3==a&&$.ajax({type:"GET",url:"SearchHelp.php",async:!1,success:function(b){"<strong>"==b.substring(0,8)&&(a=2)}})}catch(c){}return a}
function ParseKeywords(a){for(var c=[],b=a.split(/\W+/),m=0;m<b.length;m++)if(a=b[m].toLowerCase(),2<a.length){var k=a.charCodeAt(0);(48>k||57<k)&&-1==$.inArray(a,c)&&c.push(a)}return c}
function SearchForKeywords(a,c,b,m){for(var k=[],h=[],e=[],l=!0,d=0;d<a.length;d++){var f=a[d],g=b[f];if(null==g)return"<strong>Nothing found</strong>";k[f]=g;var f=[],n;for(n in g)f.push(g[n]>>16);if(l){var l=!1,p;for(p in f)h.push(f[p])}else for(g=0;g<h.length;g++)-1==$.inArray(h[g],f)&&(h.splice(g,1),g--)}if(0==h.length)return"<strong>Nothing found</strong>";for(b=0;b<h.length;b++){l=h[b];d=c[l].split(/\0/);p=d[0];for(var f=d[1],s=parseInt(d[2]),q=0,d=0;d<a.length;d++)for(n in g=k[a[d]],g){var r=
g[n];r>>16==l&&(q+=r&65535)}e.push({Filename:f,PageTitle:p,Rank:1E3*q/s});if(99<e.length)break}e.sort(function(a,b){return m?a.PageTitle.localeCompare(b.PageTitle):b.Rank-a.Rank});a="<ol>";for(var t in e)a+='<li><a href="'+e[t].Filename+'" target="_blank">'+e[t].PageTitle+"</a></li>";a+="</ol>";e.length<h.length&&(a+="<p>Omitted "+(h.length-e.length)+" more results</p>");return a};